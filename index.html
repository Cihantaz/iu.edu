<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Tercih Analiz Sistemi</title>
    <!-- Bootstrap ekle -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f4f6fb; color: #222; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 32px 36px; border-radius: 14px; box-shadow: 0 2px 12px #e0e0e0; min-height: 100vh; }
        h1 { color: #2c3e50; margin-bottom: 18px; }
        label { font-weight: 500; margin-top: 10px; }
        .footer { margin-top: 30px; display: flex; align-items: center; }
        .footer img { height: 32px; margin-right: 10px; }
        .debug { background: #f9f2f4; color: #b94a48; padding: 10px; margin: 10px 0; font-size: 13px; border-radius: 6px; }
        .eklenenler-table { margin-top: 10px; margin-bottom: 18px; }
        .ekle-btn { background: #27ae60; }
        .ekle-btn:hover { background: #219150; }
        .sil-btn { background: #e74c3c; }
        .sil-btn:hover { background: #c0392b; }
        .dropzone {
            border: 2px dashed #1e90ff;
            border-radius: 8px;
            background: #f7fafd;
            padding: 20px;
            text-align: center;
            color: #1e90ff;
            font-size: 16px;
            margin-bottom: 16px;
            cursor: pointer;
        }
        .dropzone.dragover { background: #e3f1ff; }
        @media (max-width: 900px) {
            .container { padding: 10px; }
            table, thead, tbody, tr, th, td { font-size: 13px; }
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script>
        let eklenenler = {{ eklenenler|tojson|safe }};
        function clearInputs() {
            document.getElementById('puan').value = '';
            document.getElementById('tur').selectedIndex = 0;
            document.getElementById('alt').value = '';
            document.getElementById('ust').value = '';
        }
        function eklePuan() {
            const puan = document.getElementById('puan').value;
            const tur = document.getElementById('tur').value;
            const sinir = document.getElementById('sinir').value;
            if (!puan || !tur || !sinir) {
                alert("Tüm alanları doldurun.");
                return;
            }
            eklenenler.push({puan, tur, sinir});
            guncelleTablo();
            document.getElementById('puan').value = '';
            document.getElementById('tur').selectedIndex = 0;
            document.getElementById('sinir').value = '';
        }
        function silPuan(idx) {
            eklenenler.splice(idx, 1);
            guncelleTablo();
        }
        function guncelleTablo() {
            let html = '';
            for (let i = 0; i < eklenenler.length; i++) {
                const e = eklenenler[i];
                html += `<tr>
                    <td>${e.puan}</td>
                    <td>${e.tur}</td>
                    <td>${e.sinir}</td>
                    <td><button type="button" class="sil-btn btn btn-danger btn-sm" onclick="silPuan(${i})">Sil</button></td>
                </tr>`;
            }
            document.getElementById('eklenenler_body').innerHTML = html;
            document.getElementById('eklenenler_json').value = JSON.stringify(eklenenler);
        }
        window.onload = function() {
            guncelleTablo();
        }

        // Sürükle bırak dosya yükleme
        function setupDropzone(id, inputId) {
            const dz = document.getElementById(id);
            const input = document.getElementById(inputId);
            dz.addEventListener('click', () => input.click());
            dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('dragover'); });
            dz.addEventListener('dragleave', (e) => { dz.classList.remove('dragover'); });
            dz.addEventListener('drop', (e) => {
                e.preventDefault();
                dz.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    input.files = e.dataTransfer.files;
                    dz.innerText = e.dataTransfer.files[0].name;
                }
            });
            input.addEventListener('change', () => {
                if (input.files.length > 0) {
                    dz.innerText = input.files[0].name;
                }
            });
        }
    </script>
</head>
<body style="margin:0;padding:0;">
    <div class="container">
        <div class="d-flex flex-column align-items-center mb-4">
            <img src="{{ url_for('static', filename='iu.logo.png') }}" alt="Işık Üniversitesi Logo" style="height:90px; max-width:400px; display:block; margin-bottom:10px;">
            <h1 style="margin-bottom:0; text-align:center;">Tercih Analiz Sistemi</h1>
        </div>
        <form method="post" enctype="multipart/form-data" autocomplete="off">
            <div class="row mb-3">
                <div class="col-12">
                    <label for="adsoyad" class="form-label">Öğrenci Adı Soyadı:</label>
                    <input type="text" name="adsoyad" value="{{ adsoyad }}" required class="form-control">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-4 col-12 mb-2">
                    <label for="puan" class="form-label">Sıralama</label>
                    <input type="number" id="puan" class="form-control" min="1">
                </div>
                <div class="col-md-3 col-12 mb-2">
                    <label for="tur" class="form-label">Puan Türü</label>
                    <select id="tur" class="form-select">
                        <option value="SAY">SAY</option>
                        <option value="EA">EA</option>
                        <option value="SÖZ">SÖZ</option>
                        <option value="TYT">TYT</option>
                    </select>
                </div>
                <div class="col-md-3 col-12 mb-2">
                    <label for="sinir" class="form-label">Sınır</label>
                    <input type="number" id="sinir" class="form-control" min="0">
                </div>
                <div class="col-md-2 col-12 d-flex align-items-end mb-2">
                    <button type="button" class="btn ekle-btn w-100" onclick="eklePuan()">Ekle</button>
                </div>
            </div>
            <table class="table eklenenler-table table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Sıralama</th>
                        <th>Puan Türü</th>
                        <th>Sınır</th>
                        <th>Sil</th>
                    </tr>
                </thead>
                <tbody id="eklenenler_body"></tbody>
            </table>
            <input type="hidden" name="eklenenler" id="eklenenler_json">
            <div class="row mb-3">
                <div class="col-12">
                    <div id="veri_dropzone" class="dropzone">Veri Dosyasını Sürükleyip Bırakın veya Tıklayın</div>
                    <input type="file" name="veri_dosya" id="veri_dosya" accept=".xlsx" style="display:none;">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-12 d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary">Analiz Et</button>
                </div>
            </div>
        </form>
        <script>
            setupDropzone('veri_dropzone', 'veri_dosya');
            function guncelleTablo() {
                let html = '';
                for (let i = 0; i < eklenenler.length; i++) {
                    const e = eklenenler[i];
                    html += `<tr>
                        <td>${e.puan}</td>
                        <td>${e.tur}</td>
                        <td>${e.sinir}</td>
                        <td><button type="button" class="sil-btn btn btn-danger btn-sm" onclick="silPuan(${i})">Sil</button></td>
                    </tr>`;
                }
                document.getElementById('eklenenler_body').innerHTML = html;
                document.getElementById('eklenenler_json').value = JSON.stringify(eklenenler);
            }
            function eklePuan() {
                const puan = document.getElementById('puan').value;
                const tur = document.getElementById('tur').value;
                const sinir = document.getElementById('sinir').value;
                if (!puan || !tur || !sinir) {
                    alert("Tüm alanları doldurun.");
                    return;
                }
                eklenenler.push({puan, tur, sinir});
                guncelleTablo();
                document.getElementById('puan').value = '';
                document.getElementById('tur').selectedIndex = 0;
                document.getElementById('sinir').value = '';
            }
            function silPuan(idx) {
                eklenenler.splice(idx, 1);
                guncelleTablo();
            }
            window.onload = function() {
                guncelleTablo();
            }
        </script>
        {% if debug %}
            <div class="debug">
                <b>Debug:</b><br>
                {% for d in debug %}
                    {{ d }}<br>
                {% endfor %}
            </div>
        {% endif %}
        {% if result %}
            <div style="margin-top:18px; font-size:16px; color:#1e90ff;"><b>Analiz Sonuçları</b></div>
            <form method="post" action="/download" target="_blank">
                <input type="hidden" name="eklenenler" value='{{ eklenenler|tojson }}'>
                <input type="hidden" name="adsoyad" value="{{ adsoyad }}">
                <!-- Dosya yükleme alanı download için eklenmeli, backend tarafında session ile tutulursa gerek kalmaz -->
                <button type="submit" class="btn btn-success mb-2">Excel Olarak İndir</button>
            </form>
            <div style="max-height:340px; overflow-y:auto; border-radius:10px; border:1px solid #e0e0e0; margin-bottom:16px; background:#f8fafc;">
            <table id="sonucTablo" class="display" style="width:100%; border-collapse:separate; border-spacing:0 4px;">
                <thead>
                    <tr>
                        {% for key, label in tablo_basliklari %}
                        <th style="background:#e3eaf7; color:#1e90ff; font-weight:600; border-radius:6px 6px 0 0;">{{ label }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in result %}
                    <tr style="background:#fff;">
                        {% for key, label in tablo_basliklari %}
                        <td style="border-radius:4px; border:1px solid #e0e0e0;">{{ row[key] }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
            <script>
            $(document).ready(function() {
                $('#sonucTablo').DataTable({
                    "paging": true,
                    "searching": true,
                    "ordering": true,
                    "info": true,
                    "responsive": true,
                    "language": {
                        "url": "//cdn.datatables.net/plug-ins/1.13.4/i18n/tr.json"
                    }
                });
            });
            </script>
            {% if result|length > 5 %}
                <div style="font-size:12px;color:#888;">Tablo kaydırılabilir, tüm satırları görmek için kaydırın.</div>
            {% endif %}
        {% endif %}
        <div class="footer">
            <img src="/static/mesela.png" alt="logo">
            <span>Işık Üniversitesi Öğrenci İşleri Daire Başkanlığı</span>
        </div>

        <!-- Gemini Chatbot Widget -->
        <div id="gemini-chatbot-widget" style="position:fixed;bottom:30px;right:30px;z-index:9999;">
            <div id="gemini-chatbot-toggle" style="background:#fff;border-radius:50%;box-shadow:0 2px 8px #aaa;width:56px;height:56px;display:flex;align-items:center;justify-content:center;cursor:pointer;">
                <i class="fa-brands fa-google fa-2x" style="color:#4285f4;"></i>
            </div>
            <div id="gemini-chatbot-panel" style="display:none;position:absolute;bottom:70px;right:0;width:340px;max-width:95vw;height:480px;box-shadow:0 2px 16px #aaa;background:#fff;border-radius:16px;overflow:hidden;flex-direction:column;">
                <div style="background:#4285f4;color:#fff;padding:12px 16px;font-weight:bold;display:flex;align-items:center;justify-content:space-between;">
                    <span><i class="fa-brands fa-google"></i> Gemini Chatbot</span>
                    <div>
                        <button id="gemini-chatbot-clear" title="Konuşmayı Temizle" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer;margin-right:8px;">
                            <i class="fa fa-trash"></i>
                        </button>
                        <button id="gemini-chatbot-close" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;">&times;</button>
                    </div>
                </div>
                <div id="gemini-chatbot-messages" style="flex:1;overflow-y:auto;padding:12px 8px 8px 8px;font-size:15px;background:#f7fafd;"></div>
                <form id="gemini-chatbot-form" style="display:flex;gap:6px;padding:10px;background:#f7fafd;">
                    <input id="gemini-chatbot-input" type="text" class="form-control" placeholder="Sorunuzu yazın..." autocomplete="off" style="flex:1;">
                    <button type="submit" class="btn btn-primary" style="min-width:44px;"><i class="fa fa-paper-plane"></i></button>
                </form>
            </div>
        </div>
        <script>
        document.addEventListener("DOMContentLoaded", function() {
            const toggle = document.getElementById("gemini-chatbot-toggle");
            const panel = document.getElementById("gemini-chatbot-panel");
            const closeBtn = document.getElementById("gemini-chatbot-close");
            const clearBtn = document.getElementById("gemini-chatbot-clear");
            toggle.onclick = () => { panel.style.display = panel.style.display === "none" ? "flex" : "none"; };
            closeBtn.onclick = () => { panel.style.display = "none"; };
            clearBtn.onclick = function() {
                messagesDiv.innerHTML = "";
            };

            const messagesDiv = document.getElementById("gemini-chatbot-messages");
            const form = document.getElementById("gemini-chatbot-form");
            const input = document.getElementById("gemini-chatbot-input");

            form.onsubmit = async function(e) {
                e.preventDefault();
                const userText = input.value.trim();
                if (!userText) return;
                addMessage("user", userText);
                input.value = "";
                addMessage("gemini", "<i class='fa fa-spinner fa-spin'></i> Yanıt bekleniyor...");
                try {
                    let resp = await fetch("/gemini-chat", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({prompt: userText})
                    });
                    let data = await resp.json();
                    messagesDiv.lastElementChild.innerHTML = (data.reply || "<span style='color:red'>Yanıt alınamadı.</span>")
                        + (data.debug ? "<div style='font-size:11px;color:#888;margin-top:4px;'>" + data.debug.join("<br>") + "</div>" : "");
                } catch {
                    messagesDiv.lastElementChild.innerHTML = "<span style='color:red'>Sunucu hatası.</span>";
                }
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            };

            function addMessage(role, text) {
                const div = document.createElement("div");
                div.style.marginBottom = "8px";
                if (role === "user") {
                    div.innerHTML = `<span style="color:#4285f4;font-weight:bold;"><i class="fa fa-user"></i> Siz:</span> ${text}`;
                } else {
                    div.innerHTML = `<span style="color:#34a853;font-weight:bold;"><i class="fa-brands fa-google"></i> Gemini:</span> ${text}`;
                }
                messagesDiv.appendChild(div);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        });
        </script>
    </div>
</body>
</html>
                    messagesDiv.lastElementChild.innerHTML = (data.reply || "<span style='color:red'>Yanıt alınamadı.</span>")
                        + (data.debug ? "<div style='font-size:11px;color:#888;margin-top:4px;'>" + data.debug.join("<br>") + "</div>" : "");
                } catch {
                    messagesDiv.lastElementChild.innerHTML = "<span style='color:red'>Sunucu hatası.</span>";
                }
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            };

            function addMessage(role, text) {
                const div = document.createElement("div");
                div.style.marginBottom = "8px";
                if (role === "user") {
                    div.innerHTML = `<span style="color:#4285f4;font-weight:bold;"><i class="fa fa-user"></i> Siz:</span> ${text}`;
                } else {
                    div.innerHTML = `<span style="color:#34a853;font-weight:bold;"><i class="fa-brands fa-google"></i> Gemini:</span> ${text}`;
                }
                messagesDiv.appendChild(div);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        });
        </script>
    </div>
</body>
</html>
